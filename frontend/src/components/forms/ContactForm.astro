---
// Assets
import Text from "@/components/foundations/elements/Text.astro";
import Button from "@/components/foundations/elements/Button.astro";
import SanityImage from "@/components/foundations/elements/SanityImage.astro";

interface Props {
  feature: {
    _type: "contactForm";
    header?: string;
    subheading?: any[]; // Portable text blocks
    backgroundImage?: {
      asset: { _ref: string };
      alt?: string;
    };
    successMessage?: string;
  };
}

const { feature } = Astro.props;
---

<section class="w-full bg-sand-100 dark:bg-neutral-800">
  <div class="flex flex-col h-screen lg:flex-row lg:gap-10">
    {/* Form Section - First on all screen sizes */}
    <div class="flex items-center justify-center w-full p-8 bg-sand-100 dark:bg-neutral-800 lg:w-2/3 lg:justify-start">
      <div class="w-full max-w-md py-24 lg:py-32">
      {feature.header && (
        <div class="text-center lg:text-left">
          <Text
            tag="h2"
            variant="displayMD"
            class="font-serif font-medium tracking-tight brand-heading-color"
          >
            {feature.header}
          </Text>
          {feature.subheading && (
            <Text
              tag="p"
              variant="textBase"
              class="max-w-xl mx-auto mt-4 brand-text-color text-balance"
            >
              {feature.subheading}
            </Text>
          )}
        </div>
      )}
      
      <form 
        name="contact" 
        method="POST" 
        data-netlify="true"
        data-netlify-honeypot="bot-field"
        class="mt-10 space-y-4"
        id="contact-form"
      >
        <!-- Hidden input for Netlify form identification -->
        <input type="hidden" name="form-name" value="contact" />
        
        <!-- Honeypot field for spam protection -->
        <p style="display: none;">
          <label>Don't fill this out if you're human: <input name="bot-field" /></label>
        </p>
        
        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
          <div class="w-full">
            <div class="flex items-baseline justify-between mb-1">
              <label for="firstName" class="text-sm font-medium brand-text-color">
                First Name
              </label>
            </div>
            <div class="relative z-0 focus-within:z-10">
              <input
                id="firstName"
                name="firstName"
                type="text"
                required
                placeholder="Jane"
                class="block w-full px-4 py-2 text-xs leading-tight align-middle bg-white dark:bg-neutral-700 border border-transparent transition duration-300 ease-in-out focus:z-10 h-9 rounded-md brand-text-color dark:text-neutral-200 ring-1 ring-base-200 dark:ring-neutral-600 placeholder-base-400 dark:placeholder-neutral-400 focus:border-accent-500 focus:ring-accent-100 dark:focus:ring-accent-900 focus:ring-2 focus:outline-none shadow-sm"
              />
            </div>
          </div>
          
          <div class="w-full">
            <div class="flex items-baseline justify-between mb-1">
              <label for="lastName" class="text-sm font-medium brand-text-color">
                Last Name
              </label>
            </div>
            <div class="relative z-0 focus-within:z-10">
              <input
                id="lastName"
                name="lastName"
                type="text"
                required
                placeholder="Doe"
                class="block w-full px-4 py-2 text-xs leading-tight align-middle bg-white dark:bg-neutral-700 border border-transparent transition duration-300 ease-in-out focus:z-10 h-9 rounded-md brand-text-color dark:text-neutral-200 ring-1 ring-base-200 dark:ring-neutral-600 placeholder-base-400 dark:placeholder-neutral-400 focus:border-accent-500 focus:ring-accent-100 dark:focus:ring-accent-900 focus:ring-2 focus:outline-none shadow-sm"
              />
            </div>
          </div>
        </div>

        <div class="w-full">
          <div class="flex items-baseline justify-between mb-1">
            <label for="email" class="text-sm font-medium brand-text-color">
              Email Address
            </label>
          </div>
          <div class="relative z-0 focus-within:z-10">
            <input
              id="email"
              name="email"
              type="email"
              required
              placeholder="you@example.com"
              class="block w-full px-4 py-2 text-xs leading-tight align-middle bg-white dark:bg-neutral-700 border border-transparent transition duration-300 ease-in-out focus:z-10 h-9 rounded-md brand-text-color dark:text-neutral-200 ring-1 ring-base-200 dark:ring-neutral-600 placeholder-base-400 dark:placeholder-neutral-400 focus:border-accent-500 focus:ring-accent-100 dark:focus:ring-accent-900 focus:ring-2 focus:outline-none shadow-sm"
              inputmode="email"
            />
          </div>
        </div>

        <div class="w-full">
          <div class="flex items-baseline justify-between mb-1">
            <label for="message" class="text-sm font-medium brand-text-color">
              Your Message
            </label>
          </div>
          <div class="relative z-0 focus-within:z-10">
            <textarea
              id="message"
              name="message"
              rows="4"
              required
              placeholder="What's on your mind?"
              class="block w-full px-4 py-2 text-xs leading-tight align-middle bg-white dark:bg-neutral-700 border border-transparent transition duration-300 ease-in-out focus:z-10 rounded-md brand-text-color dark:text-neutral-200 ring-1 ring-base-200 dark:ring-neutral-600 placeholder-base-400 dark:placeholder-neutral-400 focus:border-accent-500 focus:ring-accent-100 dark:focus:ring-accent-900 focus:ring-2 focus:outline-none shadow-sm"
            ></textarea>
          </div>
        </div>

        <div id="form-button-container">
          <Button
            size="base"
            variant="accent"
            gap="sm"
            type="submit"
            class="w-full"
          >
            Send Message
          </Button>
        </div>

        <div id="form-success-message" class="hidden">
          <Text
            tag="p"
            variant="textBase"
            class="text-center brand-text-color"
          >
            {feature.successMessage || "Thank you for your message! We'll get back to you soon."}
          </Text>
        </div>
      </form>
    </div>
  </div>

  {/* Background Image Section - Below form on small/medium, to the side on large */}
  {feature.backgroundImage?.asset?._ref && (
    <div
      class="relative w-full h-64 overflow-hidden lg:h-auto lg:w-1/2 lg:order-first"
    >
      <SanityImage
        image={feature.backgroundImage}
        width={1200}
        height={1200}
        loading="lazy"
        class="object-cover object-center w-full h-full bg-base-50 dark:bg-neutral-900"
      />
      <div
        aria-hidden="true"
        class="absolute inset-0 pointer-events-none bg-sand-700/50 dark:bg-neutral-800/50"
      >
      </div>
      {/* <div
        class="absolute inset-0 flex flex-col items-center justify-between p-8 text-center"
      >
        <div>
          <Text tag="p" variant="textXL" class="mt-4 font-medium text-white">
            Hello, is it me <br />
            you are looking for?
          </text>
          </div>
        </div> */}
    </div>
  )}
</section>

<script>
  // Handle form submission with inline success message
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('contact-form') as HTMLFormElement;
    const buttonContainer = document.getElementById('form-button-container');
    const successMessage = document.getElementById('form-success-message');

    if (form && buttonContainer && successMessage) {
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        const submitButton = buttonContainer.querySelector('button');
        
        // Disable submit button and show loading state
        if (submitButton) {
          submitButton.disabled = true;
          submitButton.textContent = 'Sending...';
        }
        
        console.log('[CONTACT-FORM] Starting form submission...');
        
        // Submit to Netlify Forms
        fetch('/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams(formData as any).toString()
        })
        .then(response => {
          console.log('[CONTACT-FORM] Form submission response:', response.status);
          
          // Hide button, show success message
          buttonContainer.style.display = 'none';
          successMessage.classList.remove('hidden');
          console.log('[CONTACT-FORM] Form submission completed successfully');
        })
        .catch(error => {
          console.error('[CONTACT-FORM] Form submission error:', error);
          
          // Re-enable button
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = 'Send Message';
          }
          
          alert('There was an error submitting your form. Please try again.');
        });
      });
    }
  });
</script>

<style>
  /* Dark mode support for form elements */
  .brand-heading-color {
    color: var(--heading-text-color);
  }
  
  .brand-text-color {
    color: var(--body-text-color);
  }
  
  /* Form input focus states for dark mode */
  input:focus,
  textarea:focus {
    background-color: var(--input-bg-color);
    border-color: var(--accent-color);
    color: var(--input-text-color);
  }
  
  /* Dark mode placeholder text */
  input::placeholder,
  textarea::placeholder {
    color: var(--placeholder-color);
  }
</style>
